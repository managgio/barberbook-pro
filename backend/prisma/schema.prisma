generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  client
  admin
}

enum BarberRole {
  worker
  admin
}

enum AppointmentStatus {
  scheduled
  completed
  cancelled
  no_show
}

enum AlertType {
  info
  warning
  success
}

enum DiscountType {
  percentage
  amount
}

enum OfferScope {
  all
  categories
  services
}

enum AiChatRole {
  user
  assistant
  tool
}

model User {
  id                  String      @id @default(cuid())
  firebaseUid         String?     @unique
  name                String
  email               String      @unique
  phone               String?
  role                UserRole    @default(client)
  notificationEmail   Boolean     @default(true)
  notificationWhatsapp Boolean    @default(false)
  prefersBarberSelection Boolean  @default(true)
  avatar              String?
  isSuperAdmin        Boolean     @default(false)
  adminRoleId         String?
  adminRole           AdminRole?  @relation(fields: [adminRoleId], references: [id])
  appointments        Appointment[]
  barber              Barber?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
}

model AdminRole {
  id          String   @id @default(cuid())
  name        String
  description String?
  permissions Json
  users       User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Barber {
  id          String           @id @default(cuid())
  name        String
  photo       String?          @db.Text
  photoFileId String?
  specialty   String
  role        BarberRole       @default(worker)
  bio         String?
  startDate   DateTime
  endDate     DateTime?
  isActive    Boolean          @default(true)
  userId      String?          @unique
  user        User?            @relation(fields: [userId], references: [id])
  appointments Appointment[]
  schedule    BarberSchedule?
  holidays    BarberHoliday[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model Service {
  id          String        @id @default(cuid())
  name        String
  description String
  price       Decimal       @db.Decimal(10, 2)
  duration    Int
  categoryId  String?
  category    ServiceCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  appointments Appointment[]
  offers      Offer[]       @relation("ServiceOffers")
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([categoryId])
}

model Appointment {
  id            String             @id @default(cuid())
  userId        String?
  user          User?              @relation(fields: [userId], references: [id])
  barberId      String
  barber        Barber             @relation(fields: [barberId], references: [id])
  serviceId     String
  service       Service            @relation(fields: [serviceId], references: [id])
  startDateTime DateTime
  price         Decimal            @db.Decimal(10, 2)
  status        AppointmentStatus  @default(scheduled)
  notes         String?
  guestName     String?
  guestContact  String?
  reminderSent  Boolean            @default(false)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
}

model Alert {
  id        String    @id @default(cuid())
  title     String
  message   String
  active    Boolean   @default(true)
  type      AlertType @default(info)
  startDate DateTime?
  endDate   DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model GeneralHoliday {
  id        Int      @id @default(autoincrement())
  start     DateTime
  end       DateTime
  createdAt DateTime @default(now())
}

model BarberHoliday {
  id        Int      @id @default(autoincrement())
  barberId  String
  barber    Barber   @relation(fields: [barberId], references: [id])
  start     DateTime
  end       DateTime
  createdAt DateTime @default(now())
}

model ShopSchedule {
  id        Int      @id @default(1)
  data      Json
  updatedAt DateTime @updatedAt
}

model SiteSettings {
  id        Int      @id @default(1)
  data      Json
  updatedAt DateTime @updatedAt
}

model BarberSchedule {
  id        Int      @id @default(autoincrement())
  barberId  String   @unique
  barber    Barber   @relation(fields: [barberId], references: [id])
  data      Json
  updatedAt DateTime @updatedAt
}

model ServiceCategory {
  id          String    @id @default(cuid())
  name        String
  description String?
  position    Int       @default(0)
  services    Service[]
  offers      Offer[]   @relation("OfferCategories")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Offer {
  id            String           @id @default(cuid())
  name          String
  description   String?
  discountType  DiscountType
  discountValue Decimal          @db.Decimal(10, 2)
  scope         OfferScope
  startDate     DateTime?
  endDate       DateTime?
  active        Boolean          @default(true)
  categories    ServiceCategory[] @relation("OfferCategories")
  services      Service[]        @relation("ServiceOffers")
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
}

model AiChatSession {
  id            String         @id @default(uuid())
  adminUserId   String         @map("admin_user_id")
  title         String?
  summary       String         @db.Text
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  lastMessageAt DateTime?      @map("last_message_at")
  messages      AiChatMessage[]

  @@index([adminUserId])
  @@index([lastMessageAt])
  @@map("ai_chat_sessions")
}

model AiChatMessage {
  id          String        @id @default(uuid())
  sessionId   String        @map("session_id")
  session     AiChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  role        AiChatRole
  content     String        @db.Text
  toolName    String?       @map("tool_name")
  toolPayload Json?         @map("tool_payload")
  createdAt   DateTime      @default(now()) @map("created_at")

  @@index([sessionId, createdAt])
  @@map("ai_chat_messages")
}

model AiBusinessFact {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String   @db.Text
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("ai_business_facts")
}
